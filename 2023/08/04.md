#### 2023.8.4 | CORS

CORS(Cross Origin Resource Sharing) - 한 사이트에서 주소가 다른 서버로 HTTP 요청을 보낼 때 별도의 설정을 해주지 않으면 CORS 문제로 막히게 된다. 

해커는 메일이나 별도의 게시물로 유저를 유인하여 해커가 만든 별도의 사이트에 접속하게 만든다. 해당 사이트는 브라우저에 저장된 유저의 인증정보를 탈취하여 악의적인 활동을 할 수 있다. 그렇기 때문에 브라우저에서 한 사이트에서 주소가 다른 사이트로 요청하는 것을 막고 있다. SOP(Same-Origin Policy) '동일 출처 정책'이다. 

CORS는 SOP의 반대개념으로 다른 출처 간에 리소스를 공유할 수 있도록 허락해 주는 것을 말한다. 웹사이트랑 API의 주소, 리소스는 주고받는 데이터이다. 내 사이트와 네이버 지도 API처럼 서로 다른 출처끼리 정보 요청과 반환이 가능하도록 하는 게 CORS이다. 서로 다른 출처끼리 요청을 주고받는 건 안되는게 기본값이었다. 요청을 받는 백엔드 쪽에서 CORS를 허락할 출처들을 미리 명시하여 설정한다.

내 사이트에서 네이버 지도 API로 요청을 보내면 다른 출처로의 요청이니깐 Corss-Origin의 요청인 것이다. 브라우저는 이처럼 다른 출처끼리 요청을 보낼 때는 요청에 Origin이라는 header를 추가한다. header는 데이터가 다른 곳에 전송될 때 데이터 맨 앞쪽에 붙는 보충 정보라고 보면 된다. 받는 쪽은 IP 주소, 사용할 프로토콜이나 옵션이 담기는 데 우편으로 치자면 봉투에 적힌 내용으로 볼 수 있다. header의 Origin 항목에서는 요청하는 쪽의 scheme과 도메인, 그리고 포트 정보가 담긴다. scheme란, 요청할 자원에 접근할 방법 이를테면 http, ftp, telnet 등의 프로토콜이다. 요청을 받은 네이버 지도 API 서버는 답장의 헤더에 지정된 Access-Control-Allow-Origin 정보를 실어서 보낸다. 내 사이트가 등록된 상태라면 해당 URL도 들어 있을 것이다. Origin에서 보낸 출처 값이 서버의 답장 헤더에 담긴 Access-Control-Allow-Origin에 똑같이 있으면 안전한 요청으로 간주하고, 응답 데이터를 받아오게 된다. 

토큰 등 사용자 식별 정보가 담긴 요청에 대해서는 보다 엄격한데 보내는 측에서는 요청 옵션에 credentials이라는 항목을 true로 세팅해야 하고 받는 쪽에서도 아무 출처나 다 된다는 와일드카드가 아니라 보내는 쪽의 출처 - 웹페이지 주소를 정확히 명시한 다음 Access-Control-Allow-Credentials 항목을 true로 맞춰줘야 한다. 이런 방식들은 Simple Request라고 해서 GET이나 POST 등 일정 조건의 요청들에 사용되는 것이고 PUT이나 DELETE 등 이와 다른 요청들은 본 요청을 보내기 전에 Preflight 요청이란 걸 먼저 보내서 본 요청이 안전한지 확인하고 여기서 허락이 떨어져야 본격적으로 요청을 보낼 수 있다. 서버의 데이터에 영향을 줄 수 있는 요청들이기 때문에 요청 자체를 보내기 전에 먼저 허용 여부를 검증하는 것이다. 즉 CORS에서 요청들은 두 종류 Simple Request와 Preflight 요청으로 나뉘는데 Simple Request는 요청을 보내기는 다 보내는데 통과를 못하면 답장만 못 받아오는거고 Preflight 하는 거는 요청을 '보내는' 것도 일단 허락을 받아야된다. 요청에 의해서 서버 데이터가 변경이 될 수 있는 것이기 때문에-Simple Request도 받는 쪽에서 신경을 쓰지 않으면 데이터 변경이 가능하다. 그렇기 때문에 SOP만 밑을게 아니라 개발자 쪽에서도 그런 것들을 다 대비해서 서버를 프로그래밍해야 한다. 